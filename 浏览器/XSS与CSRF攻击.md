### XSS与CSRF攻击

#### CSRF攻击

##### 概念

CSRF（Cross-site request forgery）：跨站请求伪造。

##### 攻击原理

![img](https://img2018.cnblogs.com/blog/941968/201904/941968-20190422203527996-279231194.jpg)

用户是网站A的注册用户，且登录进去，于是网站A就给用户下发cookie。

从上图可以看出，要完成一次CSRF攻击，受害者必须满足两个必要的条件：

（1）**登录受信任网站A，并在本地生成Cookie。**（如果用户没有登录网站A，那么网站B在诱导的时候，请求网站A的api接口时，会提示你登录）

（2）**在不登出A的情况下，访问危险网站B（其实是利用了网站A的漏洞）**。

我们在讲CSRF时，一定要把上面的两点说清楚。

温馨提示一下，cookie保证了用户可以处于登录状态，但网站B其实拿不到 cookie。

##### 防范措施

**方法一、Token 验证：（用的最多）**

（1）服务器发送给客户端一个token；

（2）客户端提交的表单中带着这个token。

（3）如果这个 token 不合法，那么服务器拒绝这个请求。

**方法二、隐藏令牌：**

把 token 隐藏在 http 的 head头中。

>  方法二和方法一有点像，本质上没有太大区别，只是使用方式上有区别。

**方法三、Referer 验证：**

Referer 指的是页面请求来源。意思是，只接受本站的请求，服务器才做响应；如果不是，就拦截。

#### XSS攻击

##### 概念

XSS（Cross Site Scripting）：跨域脚本攻击。

##### 攻击原理

XSS攻击的核心原理是：不需要你做任何的登录认证，它会通过合法的操作（比如在url中输入、在评论框中输入），向你的页面注入脚本（可能是js、hmtl代码块等）。

最后导致的结果可能是：

盗用Cookie破坏页面的正常结构，插入广告等恶意内容D-doss攻击。

##### 攻击方式

**1、反射型**

反射型XSS攻击**把用户输入的数据"反射"给浏览器**。该攻击方式通常诱使用户 **点击一个恶意链接**，或者 **提交一个表单**，在用户点击链接或提交表单的同时，向用户访问的网站注入脚本（ 页面跳转到攻击者预先准备的页面 ）。 

**2、存储型**

存储型XSS和反射型XSS的差别在于，**提交的代码会存储在服务器端**（数据库、内存、文件系统等），下次请求时目标页面时不用再提交XSS代码。

存储型XSS**把用户输入的带有恶意脚本的数据存储在服务器端**。当浏览器请求数据时，服务器返回脚本并执行。

常见的场景是攻击者在社区或论坛上写下一篇包含恶意 JavaScript 代码的文章或评论，文章或评论发表后，所有访问该文章或评论的用户，都会在他们的浏览器中执行这段恶意的 JavaScript 代码。

**3、基于DOM**

基于DOM的XSS是指通过恶意脚本修改页面的DOM结构。是纯粹发生在 **客户端**的攻击。

这种攻击也可以说是反射型的。 

##### 防范措施（encode + 过滤）

**1、编码：**

对于用户的任何输入要进行检查、过滤和转义。一般是检查用户输入的数据中是否包含 <，>,script 等特殊字符，如果存在，则对特殊字符进行过滤或编码。 

比如，通过转义攻击脚本:

```js
<script>alert("XSS攻击")</script>
```

可转变为字符串:

```s
&lt;script&gt;alert(&quto;XSS攻击;&quto;)&lt;&##x2F;script&gt;
```

**2、过滤：**

移除用户输入的和事件相关的属性。如onerror可以自动触发攻击，还有onclick等。（总而言是，过滤掉一些不安全的内容）移除用户输入的Style节点、Script节点、Iframe节点。（尤其是Script节点，它可是支持跨域的呀，一定要移除）。

#### CSRF 和 XSS 的区别

1、CSRF：需要用户先登录网站A，获取 cookie。XSS：不需要登录。

2、CSRF：是利用网站A本身的漏洞，去请求网站A的api。XSS：是向网站 A 注入 JS代码，然后执行 JS 里的代码，篡改网站A的内容。

参考：[XSS与CSRF攻击](https://www.cnblogs.com/Bonnie3449/p/9547188.html)